# 基本設計書：SNS投稿＋ブログ＋背景画像を自動生成するWebツール

## 1. 概要

本ドキュメントは、`要件定義書.md`に基づき、SNS投稿、ブログ記事、および関連する背景画像を自動生成するWebツールの基本的な設計を定義する。
このツールは、ユーザーが入力した商品情報から複数のSNS短文案を生成し、ユーザーが選択した案を基に、より詳細なSNS投稿（Instagram向け）、ブログ記事、および背景画像を生成する。

- **主な機能**:
    - SNS短文案の自動生成（3案）
    - 選択案に基づくSNS投稿（タイトル、本文、ハッシュタグ）とブログ記事（見出し構造、本文）の生成
    - SNS用・ブログ用の背景画像、および参考画像の自動生成
    - 生成コンテンツのコピー＆ダウンロード機能
    - 直近10件の生成履歴の保存と再利用機能

- **対象ユーザー**: 商品やサービスのプロモーションを手軽に行いたい個人・法人

## 2. システム構成

システムはNext.jsを中心としたサーバーレスアーキテクチャを採用し、Vercel上での運用を前提とする。APIキーなどの機密情報はすべてサーバーサイドで管理し、フロントエンドには公開しない。

```ascii
[Browser SPA/SSR (Next.js/React)]
     | HTTPS (Cookie Session via Auth.js)
     v
[Next.js API (Route Handlers)]
  |-- Validate Input (Zod)
  |-- Rate Limit (per user via Upstash Redis)
  |-- Call Gemini API (server-only, using ENV VAR)
  |-- Persist to DB (Prisma -> Vercel Postgres)
  |-- Store Images (Signed PUT to Supabase Storage/R2)
     |
     +-> [Google Gemini API]  (Text & Image Generation)
     +-> [PostgreSQL Database] (e.g., Vercel Postgres)
     +-> [Object Storage]  <--(Signed GET for Download)-- Browser
```

- **認証**: Auth.js (NextAuth) を利用し、Google OAuthまたはEmail Magic Linkによる認証を行う。セッションはCookieで管理する。
- **データフロー**:
    1.  クライアントはNext.jsのAPIエンドポイントにリクエストを送信する。
    2.  APIルートは入力値を検証し、レート制限をチェックする。
    3.  サーバーサイドでGemini APIを呼び出し、コンテンツ（テキスト、画像）を生成する。
    4.  生成結果とセッション情報はPostgreSQLデータベースに保存する。
    5.  生成された画像はオブジェクトストレージにアップロードする。
    6.  クライアントはAPIから生成結果を受け取り表示する。画像のダウンロードは、サーバーが発行する署名付きURLを介して行われる。

## 3. 技術スタック

| 領域 | 技術 | 理由 |
| --- | --- | --- |
| **フロントエンド** | Next.js 14 (App Router), React 18, TypeScript | RSC/サーバーアクションによるAPIキー秘匿と低レイテンシ。型安全性。 |
| **UI** | Tailwind CSS, shadcn/ui | 短納期でのモバイル最適化と一貫したデザイン。アクセシビリティ対応。 |
| **状態管理** | RSC主体 + React Query | 非同期処理の進捗管理（ポーリング/SSE）の実装が簡潔。 |
| **バックエンド** | Next.js Route Handlers | Vercelのサーバーレス環境に最適化。APIキーをサーバーのみで管理。 |
| **AI SDK** | Google AI (Gemini) Node SDK | テキスト・画像生成の統一クライアント。 |
| **認証** | Auth.js (NextAuth) | Google/Email認証を迅速かつ安全に導入。 |
| **データベース** | PostgreSQL (Vercel/Supabase) | Prismaとの親和性が高く、JSON等の柔軟なスキーマに対応。 |
| **ORM** | Prisma | スキーマ駆動開発による型安全なデータアクセスとマイグレーション管理。 |
| **ストレージ** | Supabase Storage / Cloudflare R2 | 画像の原本保管と期限付き署名URLの発行が容易。 |
| **ホスティング** | Vercel | Preview/Production環境のCI/CDパイプライン。 |
| **テスト** | Vitest (ユニット), Playwright (E2E) | 標準的なテストフレームワーク。 |

## 4. 機能一覧

本システムが提供する主要な機能を以下に示す。

| 機能カテゴリ | 機能名 | 概要 |
| --- | --- | --- |
| **コア機能** | 生成セッション開始 | 商品情報を基に、SNS短文案を3件生成する。 |
| | 短文案の選択 | 3案の中からユーザーが1案を選択する。 |
| | コンテンツ生成 | 選択案を基に、SNS投稿（タイトル,本文,タグ）とブログ記事（H1,構成,本文）を生成する。 |
| | 画像生成 | SNS用背景、ブログ用背景、参考画像を生成する。 |
| **UI機能** | コンテンツのコピー | 生成されたテキストコンテンツをクリップボードにコピーする。 |
| | 画像のダウンロード | 生成された画像をダウンロードする。 |
| **履歴管理** | 履歴の保存・表示 | 生成セッションを直近10件まで自動で保存し、一覧表示する。 |
| | 履歴からの再利用 | 過去の生成内容を基に、新しい生成セッションを開始する。 |
| | 履歴の削除 | 不要な履歴を削除する。 |
| **認証** | ユーザーログイン | Googleアカウントまたはメールアドレスでログインする。 |

## 5. データベース論理設計

データベースは、ユーザー(`User`)と生成単位(`GenerationSession`)を中心に設計される。1回の生成フロー全体が `GenerationSession` に対応する。

- **主要エンティティ**:
    - `User`: アプリケーションの利用者。
    - `GenerationSession`: ユーザーが行う一連の生成タスク（入力〜最終成果物まで）を管理する中心的なエンティティ。
    - `Draft`: 最初に生成される3つの短文案。
    - `Selection`: ユーザーが選択した `Draft` を記録。
    - `SNSContent`, `BlogContent`: 最終的に生成されたテキストコンテンツ。
    - `ImageAsset`: 生成された画像アセットの情報。
    - `History`: ユーザーの生成履歴（`GenerationSession` への参照）。

- **リレーションシップ**:
    - `User` は複数の `GenerationSession` と `History` を持つ。
    - `GenerationSession` は、複数の `Draft`、1つの `Selection`、1つの `SNSContent`、1つの `BlogContent`、複数の `ImageAsset` を関連として持つ。
    - `History` は特定の `GenerationSession` を指し示すことで、履歴データへのショートカットとして機能する。
    - 履歴はユーザーごとに最新10件に制限される（ピン留めされたものを除く）。

## 6. 画面フロー

ユーザーの操作フローと画面遷移は以下の通り。

1.  **ランディングページ (`/`)**: サービス紹介とログインへの導線。
2.  **ログインページ (`/login`)**: 認証プロバイダ（Google/Email）を選択。
3.  **ダッシュボード (`/dashboard`)**: ログイン後のメイン画面。商品情報を入力し、生成を開始する。
    - `(POST /api/sessions)`
4.  **短文案選択ページ (`/sessions/[id]/drafts`)**: 生成された3つの短文案が表示される。ユーザーは1つを選択して次に進む。
    - `(POST /api/sessions/:id/selection)`
5.  **結果表示ページ (`/sessions/[id]/result`)**: 最終的なSNS投稿、ブログ記事、画像が表示される。コンテンツのコピーやダウンロードが可能。
    - `(POST /api/sessions/:id/content, POST /api/sessions/:id/images)`
6.  **履歴ページ (`/history`)**: 過去の生成結果が一覧表示され、再利用や削除が行える。

## 7. 非機能要件

| 項目 | 要件 |
| --- | --- |
| **性能** | - 短文案生成 (Step1): p95で3秒未満<br>- テキストコンテンツ生成 (Step3): p95で5秒未満<br>- 画像生成: 20秒以内（非同期処理を許容） |
| **可用性** | - VercelのSLAに準拠。<br>- 外部API（Gemini）障害時も、部分的に成功した結果（テキストなど）は利用可能とし、画像のみ後から再生成できる導線を設ける。 |
| **セキュリティ** | - OWASP ASVS L1相当を目指す。<br>- APIキーはサーバーサイドで厳重に管理し、フロントエンドに漏洩させない。<br>- ユーザーデータは`userId`でスコープを区切り、他のユーザーからアクセスできないようにする。<br>- すべてのユーザー入力はサーバーサイドで検証・サニタイズする。<br>- 依存パッケージの脆弱性を継続的にスキャンする。 |
| **コスト管理** | - ユーザー単位でAPI利用回数にレート制限を設け、予期せぬコスト増大を防ぐ。<br>- 生成画像はWebP形式を優先し、ストレージコストと転送量を削減する。 |
